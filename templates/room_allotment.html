{% extends "base.html" %}

{% block title %}Room Allotment - Faculty Management System{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #eef5ff 0%, #f8fbff 100%);
        min-height: 100vh;
    }
    
    .upload-card {
        background: linear-gradient(135deg, #06457F 0%, #0474C4 100%);
        border: none;
        box-shadow: 0 10px 30px rgba(6, 69, 127, 0.2);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    
    .upload-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #A8C4EC, #0474C4, #06457F, #A8C4EC);
        background-size: 200% 200%;
        animation: gradient 2s ease infinite;
    }
    
    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    .card-header {
        background: rgba(255, 255, 255, 0.1) !important;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        padding: 1.5rem;
    }
    
    .card-body {
        background: rgba(255, 255, 255, 0.95);
        padding: 2rem;
    }
    
    .upload-area {
        border: 2px dashed #A8C4EC;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        background: rgba(255, 255, 255, 0.95);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .upload-area::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(168, 196, 236, 0.1), transparent);
        transform: rotate(-45deg);
        transition: all 0.6s;
        opacity: 0;
    }
    
    .upload-area:hover::before {
        animation: shimmer 1.5s ease-in-out;
        opacity: 1;
    }
    
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
    }
    
    .upload-area:hover {
        border-color: #06457F;
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(6, 69, 127, 0.15);
    }
    
    .upload-area.dragover {
        border-color: #0474C4;
        background: rgba(168, 196, 236, 0.1);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #5379AE;
        margin-bottom: 1rem;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-8px); }
    }
    
    .btn-randomize {
        background: linear-gradient(135deg, #06457F 0%, #0474C4 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(6, 69, 127, 0.25);
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .btn-randomize::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s;
    }
    
    .btn-randomize:hover::before {
        left: 100%;
    }
    
    .btn-randomize:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 69, 127, 0.4);
        background: linear-gradient(135deg, #0474C4 0%, #06457F 100%);
    }
    
    .file-info {
        background: rgba(168, 196, 236, 0.1);
        border: 1px solid rgba(168, 196, 236, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .btn-export {
        background: linear-gradient(135deg, #5379AE 0%, #06457F 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(83, 121, 174, 0.25);
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .btn-export::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.6s;
    }
    
    .btn-export:hover::before {
        left: 100%;
    }
    
    .btn-export:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(83, 121, 174, 0.4);
        background: linear-gradient(135deg, #06457F 0%, #5379AE 100%);
    }
    
    .form-check {
        transition: all 0.3s ease;
        border-radius: 8px !important;
        background: rgba(168, 196, 236, 0.1) !important;
        border: 1px solid rgba(168, 196, 236, 0.3) !important;
        padding: 15px !important;
    }
    
    .form-check:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(6, 69, 127, 0.15);
        background: rgba(168, 196, 236, 0.15) !important;
    }
    
    .form-check-input:checked {
        background-color: #06457F;
        border-color: #06457F;
        box-shadow: 0 0 0 0.2rem rgba(6, 69, 127, 0.25);
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
        color: #06457F;
    }
    
    h4, h5, h6 {
        color: #ffffff;
        font-weight: 600;
    }
    
    .btn-outline-primary {
        border: 2px solid #06457F;
        color: #06457F;
        background: transparent;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background: #06457F;
        border-color: #06457F;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(6, 69, 127, 0.3);
    }
    
    .form-check-label {
        color: #2c3e50 !important;
        font-weight: 600 !important;
    }
    
    .text-center p {
        color: #34495e;
    }
    
    .card-body h5, .card-body h6 {
        color: #2c3e50;
    }
    
    .card-body p {
        color: #34495e;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card upload-card">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #1f3c88 0%, #3f72af 100%);">
            <h4 class="mb-0"><i class="bi bi-door-open me-2"></i>Room Allotment Randomizer</h4>
        </div>
        <div class="card-body">
            <!-- File Upload Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="mb-3" style="color: #06457F; font-weight: 600;">
                        <i class="bi bi-cloud-upload me-2"></i>Upload Exam Allotment Document
                    </h5>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <h6 style="color: #06457F; font-weight: 600;">Drop your document here or click to browse</h6>
                        <p style="color: #5379AE; margin-bottom: 1rem;">Supports .doc, .docx, .html files</p>
                        <input type="file" id="fileInput" accept=".doc,.docx,.html" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click();">
                            <i class="bi bi-folder2-open me-1"></i>Choose File
                        </button>
                    </div>
                </div>
            </div>

            <!-- File Information -->
            <div id="fileInfo" class="file-info d-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1" style="color: #06457F;"><i class="bi bi-file-check me-1"></i>File Uploaded</h6>
                        <p class="mb-0" id="fileName" style="color: #5379AE;"></p>
                    </div>
                    <button type="button" class="btn btn-randomize" id="randomizeBtn">
                        <i class="bi bi-shuffle me-1"></i>Randomize Invigilators
                    </button>
                </div>
            </div>

            <!-- Department-wise Processing Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="mb-3" style="color: #06457F; font-weight: 600;">
                        <i class="bi bi-building me-2"></i>Department-wise Document Processing
                    </h5>
                    <div class="upload-area" id="deptUploadArea">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-spreadsheet"></i>
                        </div>
                        <h6 style="color: #06457F; font-weight: 600;">Upload Department-wise Allotment Document</h6>
                        <p style="color: #5379AE; margin-bottom: 1rem;">Process department-wise exam allotments with separate professor/non-professor tables</p>
                        <input type="file" id="deptFileInput" accept=".doc,.docx,.html" style="display: none;">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('deptFileInput').click();">
                            <i class="bi bi-folder2-open me-1"></i>Choose Department File
                        </button>
                    </div>
                </div>
            </div>

            <!-- Department File Information -->
            <div id="deptFileInfo" class="file-info d-none">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-1" style="color: #06457F;"><i class="bi bi-file-check me-1"></i>Department File Uploaded</h6>
                        <p class="mb-0" id="deptFileName" style="color: #5379AE;"></p>
                    </div>
                    <button type="button" class="btn btn-randomize" id="processDeptBtn">
                        <i class="bi bi-gear me-1"></i>Process Department Data
                    </button>
                </div>
            </div>

            <!-- Department Selection Section -->
            <div id="deptSelectionSection" class="d-none mb-4">
                <h5 class="mb-3" style="color: #06457F; font-weight: 600;">
                    <i class="bi bi-list-check me-2"></i>Select Departments to Export
                </h5>
                <div class="row" id="deptCheckboxes">
                    <!-- Department checkboxes will be added here dynamically -->
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-export me-3" id="exportDeptBtn">
                        <i class="bi bi-download me-1"></i>Export as DOC
                    </button>
                    <button type="button" class="btn btn-export" id="exportDeptPdfBtn">
                        <i class="bi bi-file-pdf me-1"></i>Export as PDF
                    </button>
                </div>
            </div>

            <!-- Date Selection Section -->
            <div id="dateSelectionSection" class="d-none mb-4">
                <h5 class="mb-3" style="color: #06457F; font-weight: 600;">
                    <i class="bi bi-calendar-check me-2"></i>Select Date(s) to Export
                </h5>
                <div class="row" id="dateCheckboxes">
                    <!-- Date checkboxes will be added here dynamically -->
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-export me-3" id="exportSelectedBtn">
                        <i class="bi bi-download me-1"></i>Export as DOC
                    </button>
                    <button type="button" class="btn btn-export" id="exportSelectedPdfBtn">
                        <i class="bi bi-file-pdf me-1"></i>Export as PDF
                    </button>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="processingStatus" class="d-none">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2" style="color: #06457F;">Processing document and randomizing sessions...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('Room Allotment page loaded');
    
    let sessionData = {}; // { "date": { "morning": {...}, "afternoon": {...} } }
    let uploadedFileName = '';
    let departmentData = {}; // { "DEPT_NAME": { "professors": [...], "nonProfessors": [...], "dates": [...] } }
    let deptUploadedFileName = '';
    
    // File upload handling
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    
    // Click to upload
    uploadArea.on('click', function() {
        fileInput.click();
    });
    
    // Drag and drop functionality
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
    
    // File input change
    fileInput.on('change', function() {
        if (this.files.length > 0) {
            handleFile(this.files[0]);
        }
    });
    
    // Department file upload handling
    const deptUploadArea = $('#deptUploadArea');
    const deptFileInput = $('#deptFileInput');
    
    // Click to upload department file
    deptUploadArea.on('click', function() {
        deptFileInput.click();
    });
    
    // Department drag and drop functionality
    deptUploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    deptUploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    deptUploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            handleDeptFile(files[0]);
        }
    });
    
    // Department file input change
    deptFileInput.on('change', function() {
        if (this.files.length > 0) {
            handleDeptFile(this.files[0]);
        }
    });
    
    function handleFile(file) {
        uploadedFileName = file.name;
        $('#fileName').text(file.name);
        $('#fileInfo').removeClass('d-none');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseSessionData(content);
        };
        reader.readAsText(file);
    }
    
    function parseSessionData(content) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');
        sessionData = {};
        
        // Find all sections in the document
        const allElements = doc.querySelectorAll('*');
        let currentDate = '';
        let currentSession = '';
        let currentExamInfo = {};
        
        for (let i = 0; i < allElements.length; i++) {
            const element = allElements[i];
            const text = element.textContent.trim();
            
            // Look for date information
            if (text.includes('Date of Exam')) {
                const dateMatch = text.match(/Date of Exam\s*:\s*(.+?)(?:AM|PM|$)/i);
                if (dateMatch) {
                    const fullDateText = dateMatch[1].trim();
                    // Extract just the date part (before AM/PM)
                    const dateParts = fullDateText.split(' ');
                    currentDate = dateParts[0]; // Get just the date part
                    
                    // Determine session
                    if (text.includes('AM')) {
                        currentSession = 'morning';
                    } else if (text.includes('PM')) {
                        currentSession = 'afternoon';
                    }
                }
            }
            
            // Look for exam info (rooms, reliever, total) - can be in same or different elements
            if (text.includes('Number of Rooms') || text.includes('Reliever') || text.includes('Total Invigilators')) {
                const roomsMatch = text.match(/Number of Rooms\s*:\s*(\d+)/i);
                const relieverMatch = text.match(/Reliever\s*:\s*(\d+)/i);
                const totalMatch = text.match(/Total Invigilators\s*:\s*(\d+)/i);
                
                if (roomsMatch || relieverMatch || totalMatch) {
                    currentExamInfo = {
                        rooms: roomsMatch ? roomsMatch[1] : (currentExamInfo.rooms || ''),
                        reliever: relieverMatch ? relieverMatch[1] : (currentExamInfo.reliever || ''),
                        totalInvigilators: totalMatch ? totalMatch[1] : (currentExamInfo.totalInvigilators || '')
                    };
                    console.log('Found exam info:', currentExamInfo);
                }
            }
            
            // Look for session titles
            if (text.match(/^(MORNING|AFTERNOON)\s+SESSION$/i)) {
                currentSession = text.toLowerCase().includes('morning') ? 'morning' : 'afternoon';
            }
            
            // Look for tables (Deputy Superintendents and Invigilators)
            if (element.tagName === 'TABLE') {
                const rows = element.querySelectorAll('tr');
                let isDeputyTable = false;
                let isInvigilatorTable = false;
                let deputies = [];
                let invigilators = [];
                
                for (let j = 0; j < rows.length; j++) {
                    const row = rows[j];
                    const cells = row.querySelectorAll('td, th');
                    
                    if (cells.length > 0) {
                        const headerText = Array.from(cells).map(cell => cell.textContent.trim().toLowerCase()).join(' ');
                        
                        // Check if this is a deputy superintendents table header
                        if (headerText.includes('sl no') && headerText.includes('name') && 
                            headerText.includes('dept') && headerText.includes('contact') &&
                            !headerText.includes('alloted room')) {
                            isDeputyTable = true;
                            isInvigilatorTable = false;
                            continue; // Skip header row
                        }
                        
                        // Check if this is an invigilator table header
                        if (headerText.includes('sl no') && headerText.includes('name') && 
                            headerText.includes('dept') && headerText.includes('contact') &&
                            headerText.includes('alloted room')) {
                            isInvigilatorTable = true;
                            isDeputyTable = false;
                            continue; // Skip header row
                        }
                        
                        // Collect deputy superintendent data
                        if (isDeputyTable && cells.length >= 6) {
                            const name = cells[1].textContent.trim();
                            
                            if (name && name.toLowerCase() !== 'name' && 
                                name.toLowerCase() !== 'no allocations found' &&
                                !name.toLowerCase().includes('list of')) {
                                
                                deputies.push({
                                    slNo: cells[0].textContent.trim(),
                                    name: name,
                                    designation: cells[2].textContent.trim(),
                                    initials: cells[3].textContent.trim(),
                                    contact: cells[4].textContent.trim(),
                                    dept: cells[5].textContent.trim()
                                });
                            }
                        }
                        
                        // Collect invigilator data
                        if (isInvigilatorTable && cells.length >= 6) {
                            const name = cells[1].textContent.trim();
                            
                            if (name && name.toLowerCase() !== 'name' && 
                                name.toLowerCase() !== 'no allocations found' &&
                                !name.toLowerCase().includes('list of')) {
                                
                                invigilators.push({
                                    slNo: cells[0].textContent.trim(),
                                    name: name,
                                    designation: cells[2].textContent.trim(),
                                    initials: cells[3].textContent.trim(),
                                    contact: cells[4].textContent.trim(),
                                    dept: cells[5].textContent.trim(),
                                    room: cells.length > 6 ? cells[6].textContent.trim() : ''
                                });
                            }
                        }
                    }
                }
                
                // Store data if we found any and have current date/session info
                if (currentDate && currentSession) {
                    if (!sessionData[currentDate]) {
                        sessionData[currentDate] = {};
                    }
                    if (!sessionData[currentDate][currentSession]) {
                        sessionData[currentDate][currentSession] = {
                            examInfo: currentExamInfo,
                            deputies: [],
                            invigilators: []
                        };
                    }
                    
                    if (deputies.length > 0) {
                        sessionData[currentDate][currentSession].deputies = deputies;
                    }
                    if (invigilators.length > 0) {
                        sessionData[currentDate][currentSession].invigilators = invigilators;
                    }
                }
            }
        }
        
        console.log('Parsed session data:', sessionData);
        
        if (Object.keys(sessionData).length === 0) {
            alert('No session data found in the uploaded document. Please make sure the document contains date-wise exam sessions.');
            return;
        }
    }
    
    function handleDeptFile(file) {
        deptUploadedFileName = file.name;
        $('#deptFileName').text(file.name);
        $('#deptFileInfo').removeClass('d-none');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseDepartmentData(content);
        };
        reader.readAsText(file);
    }
    
    function parseDepartmentData(content) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(content, 'text/html');
        departmentData = {};
        
        // Find all department sections - try multiple selectors
        let departmentSections = doc.querySelectorAll('.department-section');
        
        // If no sections found with class, try finding by h4 elements that contain department info
        if (departmentSections.length === 0) {
            const allH4s = doc.querySelectorAll('h4');
            departmentSections = [];
            allH4s.forEach(h4 => {
                const text = h4.textContent.trim();
                if (text.match(/^[A-Z&]+\s*-.*Exam Allotment/i)) {
                    // Find the parent container or create a virtual section
                    let section = h4.closest('div') || h4.parentElement;
                    if (section) {
                        departmentSections.push(section);
                    }
                }
            });
        }
        
        // If still no sections found, try to find all tables and work backwards
        if (departmentSections.length === 0) {
            console.log('No department sections found, trying table-based approach');
            const allTables = doc.querySelectorAll('table');
            console.log('Found tables:', allTables.length);
            
            allTables.forEach((table, index) => {
                // Look for a heading before this table
                let currentElement = table.previousElementSibling;
                let headerFound = false;
                
                // Search backwards for a header
                while (currentElement && !headerFound) {
                    if (currentElement.tagName && currentElement.tagName.match(/^H[1-6]$/)) {
                        const text = currentElement.textContent.trim();
                        if (text.match(/[A-Z&]+.*Exam Allotment/i) || text.match(/^[A-Z&]+\s*-/)) {
                            // Create a virtual section
                            const virtualSection = document.createElement('div');
                            virtualSection.appendChild(currentElement.cloneNode(true));
                            virtualSection.appendChild(table.cloneNode(true));
                            departmentSections.push(virtualSection);
                            headerFound = true;
                            console.log('Found department via table approach:', text);
                        }
                    }
                    currentElement = currentElement.previousElementSibling;
                }
            });
        }
        
        console.log('Found department sections:', departmentSections.length);
        
        departmentSections.forEach((section, index) => {
            const headerElement = section.querySelector('h4') || section.querySelector('h3') || section.querySelector('h2');
            if (!headerElement) {
                console.log(`No header found in section ${index}`);
                return;
            }
            
            const headerText = headerElement.textContent.trim();
            console.log('Processing header text:', headerText);
            
            // Try multiple regex patterns to extract department name
            let deptMatch = headerText.match(/^([A-Z&]+)\s*-/);
            if (!deptMatch) {
                deptMatch = headerText.match(/([A-Z&]+).*Exam Allotment/i);
            }
            if (!deptMatch) {
                deptMatch = headerText.match(/^([A-Z&]+)/);
            }
            
            if (!deptMatch) {
                console.log('No department match found for:', headerText);
                return;
            }
            
            const deptName = deptMatch[1].trim();
            console.log('Processing department:', deptName);
            
            const table = section.querySelector('table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tr');
            if (rows.length < 3) return; // Need at least header rows and one data row
            
            // Extract date columns from header
            const headerRow1 = rows[0];
            const headerRow2 = rows[1];
            const dateColumns = [];
            const headerCells1 = headerRow1.querySelectorAll('th');
            const headerCells2 = headerRow2.querySelectorAll('th');
            
            // Skip first 6 columns (Name, Initials, Designation, Department, Phone, Email)
            for (let i = 6; i < headerCells1.length; i++) {
                const dateText = headerCells1[i].textContent.trim();
                const sessionText = headerCells2[i] ? headerCells2[i].textContent.trim() : '';
                if (dateText && dateText !== '') {
                    dateColumns.push({
                        date: dateText,
                        session: sessionText,
                        index: i
                    });
                }
            }
            
            const professors = [];
            const nonProfessors = [];
            
            // Process data rows (skip first 2 header rows)
            for (let i = 2; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.querySelectorAll('td');
                
                if (cells.length < 6) continue;
                
                const name = cells[0].textContent.trim();
                const initials = cells[1].textContent.trim();
                const designation = cells[2].textContent.trim();
                const department = cells[3].textContent.trim();
                const phone = cells[4].textContent.trim();
                const email = cells[5].textContent.trim();
                
                if (!name || name === '') continue;
                
                // Extract allocated dates
                const allocatedDates = [];
                dateColumns.forEach(dateCol => {
                    if (cells[dateCol.index]) {
                        const cellText = cells[dateCol.index].textContent.trim();
                        if (cellText && cellText !== '') {
                            allocatedDates.push(cellText);
                        }
                    }
                });
                
                const personData = {
                    name: name,
                    initials: initials,
                    designation: designation,
                    department: department,
                    phone: phone,
                    email: email,
                    allocatedDates: allocatedDates
                };
                
                // Separate professors from non-professors based ONLY on designation column
                const designationLower = designation.toLowerCase().trim();
                
                // Professors: Only "Professor" (exact match)
                const isProfessor = designationLower === 'professor';
                
                // Invigilators: Everything else (Associate Professor, Assistant Professor, etc.)
                const finalClassification = isProfessor ? 'professor' : 'invigilator';
                
                console.log(`${name} - Designation: "${designation}" - Classification: ${finalClassification}`);
                
                if (finalClassification === 'professor') {
                    professors.push(personData);
                } else {
                    nonProfessors.push(personData);
                }
            }
            
            departmentData[deptName] = {
                professors: professors,
                nonProfessors: nonProfessors,
                dateColumns: dateColumns
            };
            
            console.log(`Department ${deptName}: ${professors.length} professors, ${nonProfessors.length} non-professors`);
        });
        
        console.log('Parsed department data:', departmentData);
        console.log('Total departments found:', Object.keys(departmentData).length);
        console.log('Department names:', Object.keys(departmentData));
        
        if (Object.keys(departmentData).length === 0) {
            alert('No department data found in the uploaded document. Please make sure the document contains department-wise exam allotments.');
            return;
        }
        
        // Show success message with count
        //alert(`Successfully parsed ${Object.keys(departmentData).length} departments: ${Object.keys(departmentData).join(', ')}`);
    }
    
    // Randomize button click
    $('#randomizeBtn').on('click', function() {
        if (Object.keys(sessionData).length === 0) {
            alert('Please upload a document first.');
            return;
        }
        
        $('#processingStatus').removeClass('d-none');
        
        // Randomize each session separately
        setTimeout(() => {
            randomizeAllSessions();
            showDateSelection();
            $('#processingStatus').addClass('d-none');
        }, 1000);
    });
    
    // Process Department button click
    $('#processDeptBtn').on('click', function() {
        if (Object.keys(departmentData).length === 0) {
            alert('Please upload a department document first.');
            return;
        }
        
        $('#processingStatus').removeClass('d-none');
        
        setTimeout(() => {
            showDepartmentSelection();
            $('#processingStatus').addClass('d-none');
        }, 500);
    });
    
    function showDepartmentSelection() {
        const deptCheckboxes = $('#deptCheckboxes');
        deptCheckboxes.empty();
        
        const sortedDepartments = Object.keys(departmentData).sort();
        
        sortedDepartments.forEach(deptName => {
            const deptInfo = departmentData[deptName];
            const profCount = deptInfo.professors.length;
            const nonProfCount = deptInfo.nonProfessors.length;
            const totalCount = profCount + nonProfCount;
            
            const checkbox = `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="form-check" style="background: rgba(168, 196, 236, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(168, 196, 236, 0.3);">
                        <input class="form-check-input" type="checkbox" value="${deptName}" id="dept_${deptName.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <label class="form-check-label" for="dept_${deptName.replace(/[^a-zA-Z0-9]/g, '_')}" style="color: #06457F; font-weight: 500;">
                            <strong>${deptName}</strong><br>
                            <small>Professors: ${profCount}, Others: ${nonProfCount}, Total: ${totalCount}</small>
                        </label>
                    </div>
                </div>
            `;
            deptCheckboxes.append(checkbox);
        });
        
        $('#deptSelectionSection').removeClass('d-none');
    }
    
    function randomizeAllSessions() {
        // Predefined room list
        const roomList = [
            'GJCB101', 'GJCB102', 'GJCB105', 'GJCB106', 'GJCB107', 'GJCB201', 'GJCB202', 'GJCB205', 'GJCB207', 'GJCB208', 
            'GJCB301', 'GJCB302', 'GJCB305', 'GJCB307', 'GJCB308', 'GJCB401', 'GJCB402', 'GJCB405', 'GJCB407', 'GJCB408',
            'CSL001', 'CSL002', 'CSL003', 'CSL101', 'CSL102', 'CSL103', 'CSL104', 'CSL105',
            'ISE301', 'ISE302', 'ISE303', 'ISE304', 'ISE305', 'ISE306',
            'E&C201A', 'E&C201B', 'E&C301A', 'E&C301B', 'E&C302', 'E&C402', 'E&C403', 'E&C404', 'E&C405', 'E&C406', 'E&C407',
            'TEL101A', 'TEL101B',
            'MEL102', 'MEL103', 'MEL301', 'MEL302', 'MEL303', 'MEL306', 'MEL307',
            'CHL201', 'CHL202', 'CHL203', 'CHL204'
        ];
        
        Object.keys(sessionData).forEach(date => {
            Object.keys(sessionData[date]).forEach(session => {
                const sessionInfo = sessionData[date][session];
                
                // Only randomize invigilators, keep deputies as-is
                if (sessionInfo.invigilators && sessionInfo.invigilators.length > 0) {
                    // Fisher-Yates shuffle for invigilators only
                    const invigilators = [...sessionInfo.invigilators];
                    for (let i = invigilators.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [invigilators[i], invigilators[j]] = [invigilators[j], invigilators[i]];
                    }
                    
                    // Renumber serial numbers for invigilators
                    invigilators.forEach((invigilator, index) => {
                        invigilator.slNo = (index + 1).toString();
                    });
                    
                    // Allocate rooms based on Number of Rooms
                    const numberOfRooms = parseInt(sessionInfo.examInfo.rooms) || 0;
                    console.log(`Allocating rooms for ${date} ${session}: ${numberOfRooms} rooms`);
                    allocateRooms(invigilators, roomList, numberOfRooms);
                    console.log('Room allocation completed:', invigilators.map(inv => `${inv.name}: ${inv.room}`));
                    
                    sessionInfo.invigilators = invigilators;
                }
                
                // Keep deputies unchanged (no randomization)
                // Deputies serial numbers remain as they were in the original document
            });
        });
    }
    
    function allocateRooms(invigilators, roomList, numberOfRooms) {
        console.log(`Starting room allocation: ${numberOfRooms} rooms for ${invigilators.length} invigilators`);
        
        let roomIndex = 0;
        let invigilatorIndex = 0;
        let roomsAllocated = 0;
        
        // If numberOfRooms is 0 or invalid, mark all as Extra
        if (numberOfRooms <= 0) {
            console.log('No rooms to allocate, marking all as Extra');
            invigilators.forEach(inv => inv.room = 'Extra');
            return;
        }
        
        while (roomsAllocated < numberOfRooms && roomIndex < roomList.length && invigilatorIndex < invigilators.length) {
            // Allocate 5 rooms
            for (let i = 0; i < 5 && roomsAllocated < numberOfRooms && roomIndex < roomList.length && invigilatorIndex < invigilators.length; i++) {
                invigilators[invigilatorIndex].room = roomList[roomIndex];
                console.log(`Assigned ${roomList[roomIndex]} to ${invigilators[invigilatorIndex].name}`);
                roomIndex++;
                invigilatorIndex++;
                roomsAllocated++;
            }
            
            // Add reliever after every 5 rooms (if we still have rooms to allocate and invigilators available)
            if (roomsAllocated < numberOfRooms && invigilatorIndex < invigilators.length) {
                invigilators[invigilatorIndex].room = 'Reliever';
                console.log(`Assigned Reliever to ${invigilators[invigilatorIndex].name}`);
                invigilatorIndex++;
            }
        }
        
        // Mark remaining invigilators as "Extra"
        while (invigilatorIndex < invigilators.length) {
            invigilators[invigilatorIndex].room = 'Extra';
            console.log(`Marked ${invigilators[invigilatorIndex].name} as Extra`);
            invigilatorIndex++;
        }
        
        console.log(`Room allocation completed: ${roomsAllocated} rooms allocated, ${invigilators.length - invigilatorIndex + (invigilatorIndex - roomsAllocated)} extras`);
    }
    
    function showDateSelection() {
        const dateCheckboxes = $('#dateCheckboxes');
        dateCheckboxes.empty();
        
        const sortedDates = Object.keys(sessionData).sort((a, b) => {
            return new Date(convertDateFormat(a)) - new Date(convertDateFormat(b));
        });
        
        sortedDates.forEach(date => {
            const sessions = Object.keys(sessionData[date]);
            
            sessions.forEach(session => {
                const sessionLabel = session === 'morning' ? 'AM' : 'PM';
                const sessionData_item = sessionData[date][session];
                const deputyCount = sessionData_item.deputies ? sessionData_item.deputies.length : 0;
                const invigilatorCount = sessionData_item.invigilators ? sessionData_item.invigilators.length : 0;
                
                const checkbox = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="form-check" style="background: rgba(168, 196, 236, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(168, 196, 236, 0.3);">
                            <input class="form-check-input" type="checkbox" value="${date}|${session}" id="date_${date.replace(/\//g, '_')}_${session}">
                            <label class="form-check-label" for="date_${date.replace(/\//g, '_')}_${session}" style="color: #06457F; font-weight: 500;">
                                <strong>${date} ${sessionLabel}</strong><br>
                                <small>Deputies: ${deputyCount}, Invigilators: ${invigilatorCount}</small>
                            </label>
                        </div>
                    </div>
                `;
                dateCheckboxes.append(checkbox);
            });
        });
        
        $('#dateSelectionSection').removeClass('d-none');
    }
    
    function convertDateFormat(dateStr) {
        // Convert DD/MM/YYYY or DD-MM-YYYY to YYYY-MM-DD
        const parts = dateStr.split(/[\/\-]/);
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        return dateStr;
    }
    
    // Export selected dates
    $('#exportSelectedBtn').on('click', function() {
        const selectedSessions = [];
        $('#dateCheckboxes input[type="checkbox"]:checked').each(function() {
            selectedSessions.push($(this).val());
        });
        
        if (selectedSessions.length === 0) {
            alert('Please select at least one session to export.');
            return;
        }
        
        exportSelectedSessions(selectedSessions);
    });
    
    function formatDateToFullFormat(dateStr) {
        console.log('Formatting date:', dateStr);
        
        // Handle different date formats
        let day, month, year;
        
        // Try DD/MM/YYYY or DD-MM-YYYY format
        let parts = dateStr.split(/[\/\-]/);
        if (parts.length === 3) {
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
            year = parseInt(parts[2], 10);
        } else {
            // If it's just a number like "22", assume current month/year
            const currentDate = new Date();
            day = parseInt(dateStr, 10);
            month = currentDate.getMonth() + 1; // Current month
            year = currentDate.getFullYear(); // Current year
        }
        
        // Validate and create date
        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const formattedDate = `${day} ${monthNames[month - 1]} ${year}`;
            console.log('Formatted date result:', formattedDate);
            return formattedDate;
        }
        
        console.log('Date formatting failed, returning original:', dateStr);
        return dateStr; // Return original if parsing fails
    }
    
    function exportSelectedSessions(selectedSessions) {
        let documentContent = '';
        
        selectedSessions.forEach((sessionKey, index) => {
            const [date, session] = sessionKey.split('|');
            const sessionInfo = sessionData[date][session];
            const sessionLabel = session === 'morning' ? 'MORNING' : 'AFTERNOON';
            const sessionCode = session === 'morning' ? 'AM' : 'PM';
            
            console.log(`Exporting ${date} ${session}:`, sessionInfo.invigilators?.map(inv => `${inv.name}: ${inv.room}`));
            
            // Format date to full format (e.g., "22 October 2025")
            const formattedDate = formatDateToFullFormat(date);
            
            documentContent += `
                <div class="header">SIDDAGANGA INSTITUTE OF TECHNOLOGY, TUMKUR</div>
                <div class="exam-info">
                    <span><strong>Date of Exam:</strong> ${formattedDate} ${sessionCode}</span>
                    <span><strong>Number of Rooms:</strong> ${sessionInfo.examInfo.rooms || ''}</span>
                    <span><strong>Reliever:</strong> ${sessionInfo.examInfo.reliever || ''}</span>
                    <span><strong>Total Invigilators:</strong> ${sessionInfo.invigilators ? sessionInfo.invigilators.length : 0}</span>
                </div>
                <div class="session-title">${sessionLabel} SESSION</div>
                
                <div class="section-title">List of Deputy Superintendents</div>
                <table>
                    <tr>
                        <th>Sl No</th>
                        <th>Name</th>
                        <th>Designation</th>
                        <th>Initials</th>
                        <th>Contact No</th>
                        <th>Dept</th>
                    </tr>
                    ${sessionInfo.deputies && sessionInfo.deputies.length > 0 ? 
                        sessionInfo.deputies.map(deputy => `
                            <tr>
                                <td>${deputy.slNo}</td>
                                <td>${deputy.name}</td>
                                <td>${deputy.designation}</td>
                                <td>${deputy.initials}</td>
                                <td>${deputy.contact}</td>
                                <td>${deputy.dept}</td>
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="6">No Deputy Superintendents found for this session.</td></tr>'
                    }
                </table>
                
                <div class="section-title">List of Invigilators</div>
                <table>
                    <tr>
                        <th>Sl No</th>
                        <th>Name</th>
                        <th>Designation</th>
                        <th>Initials</th>
                        <th>Contact No</th>
                        <th>Dept</th>
                        <th>Alloted Room / Relieving ( R )</th>
                    </tr>
                    ${sessionInfo.invigilators && sessionInfo.invigilators.length > 0 ? 
                        sessionInfo.invigilators.map(invigilator => `
                            <tr>
                                <td>${invigilator.slNo}</td>
                                <td>${invigilator.name}</td>
                                <td>${invigilator.designation}</td>
                                <td>${invigilator.initials}</td>
                                <td>${invigilator.contact}</td>
                                <td>${invigilator.dept}</td>
                                <td>${invigilator.room || ''}</td>
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="7">No Invigilators found for this session.</td></tr>'
                    }
                </table>
                <div style="page-break-after: always;"></div>
            `;
        });
        
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Randomized Room Allotment</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                    .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 20px; }
                    .exam-info { margin-bottom: 15px; }
                    .exam-info span { display: inline-block; margin-right: 30px; }
                    .session-title { font-weight: bold; font-size: 14px; margin: 20px 0 10px 0; text-align: center; }
                    .section-title { font-weight: bold; margin: 15px 0 5px 0; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
                    th, td { border: 1px solid #000; padding: 5px; text-align: left; font-size: 12px; }
                    th { background-color: #f0f0f0; font-weight: bold; }
                </style>
            </head>
            <body>
                ${documentContent}
            </body>
            </html>
        `;
        
        const blob = new Blob([htmlContent], { type: 'application/msword' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const timestamp = new Date().toISOString().split('T')[0];
        
        // Generate filename based on selected sessions
        let filename;
        if (selectedSessions.length === 1) {
            const [date, session] = selectedSessions[0].split('|');
            const sessionCode = session === 'morning' ? 'AM' : 'PM';
            filename = `Randomized_Room_Allotment_${date.replace(/\//g, '-')}_${sessionCode}_${timestamp}.doc`;
        } else {
            // Multiple sessions selected
            const firstSession = selectedSessions[0].split('|');
            const lastSession = selectedSessions[selectedSessions.length - 1].split('|');
            filename = `Randomized_Room_Allotment_${firstSession[0].replace(/\//g, '-')}_to_${lastSession[0].replace(/\//g, '-')}_${timestamp}.doc`;
        }
        a.download = filename;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
    
    // Export selected dates as PDF
    $('#exportSelectedPdfBtn').on('click', function() {
        const selectedSessions = [];
        $('#dateCheckboxes input[type="checkbox"]:checked').each(function() {
            selectedSessions.push($(this).val());
        });
        
        if (selectedSessions.length === 0) {
            alert('Please select at least one date/session to export.');
            return;
        }
        
        exportSelectedSessionsPDF(selectedSessions);
    });
    
    function exportSelectedSessionsPDF(selectedSessions) {
        let documentContent = '';
        
        selectedSessions.forEach((sessionKey, index) => {
            const [date, session] = sessionKey.split('|');
            const sessionInfo = sessionData[date][session];
            const sessionLabel = session === 'morning' ? 'MORNING' : 'AFTERNOON';
            const sessionCode = session === 'morning' ? 'AM' : 'PM';
            
            // Format date to full format (e.g., "22 October 2025")
            const formattedDate = formatDateToFullFormat(date);
            
            documentContent += `
                <div class="header">SIDDAGANGA INSTITUTE OF TECHNOLOGY, TUMKUR</div>
                <div class="exam-info">
                    <span><strong>Date of Exam:</strong> ${formattedDate} ${sessionCode}</span>
                    <span><strong>Number of Rooms:</strong> ${sessionInfo.examInfo.rooms || ''}</span>
                    <span><strong>Reliever:</strong> ${sessionInfo.examInfo.reliever || ''}</span>
                    <span><strong>Total Invigilators:</strong> ${sessionInfo.invigilators ? sessionInfo.invigilators.length : 0}</span>
                </div>
                <div class="session-title">${sessionLabel} SESSION</div>
                
                <div class="section-title">List of Deputy Superintendents</div>
                <table>
                    <tr>
                        <th>Sl No</th>
                        <th>Name</th>
                        <th>Designation</th>
                        <th>Initials</th>
                        <th>Contact No</th>
                        <th>Dept</th>
                    </tr>
                    ${sessionInfo.deputies && sessionInfo.deputies.length > 0 ? 
                        sessionInfo.deputies.map(deputy => `
                            <tr>
                                <td>${deputy.slNo}</td>
                                <td>${deputy.name}</td>
                                <td>${deputy.designation}</td>
                                <td>${deputy.initials}</td>
                                <td>${deputy.contact}</td>
                                <td>${deputy.dept}</td>
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="6">No Deputy Superintendents found for this session.</td></tr>'
                    }
                </table>
                
                <div class="section-title">List of Invigilators</div>
                <table>
                    <tr>
                        <th>Sl No</th>
                        <th>Name</th>
                        <th>Designation</th>
                        <th>Initials</th>
                        <th>Contact No</th>
                        <th>Dept</th>
                        <th>Alloted Room / Relieving ( R )</th>
                    </tr>
                    ${sessionInfo.invigilators && sessionInfo.invigilators.length > 0 ? 
                        sessionInfo.invigilators.map(invigilator => `
                            <tr>
                                <td>${invigilator.slNo}</td>
                                <td>${invigilator.name}</td>
                                <td>${invigilator.designation}</td>
                                <td>${invigilator.initials}</td>
                                <td>${invigilator.contact}</td>
                                <td>${invigilator.dept}</td>
                                <td>${invigilator.room || ''}</td>
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="7">No Invigilators found for this session.</td></tr>'
                    }
                </table>
                <div style="page-break-after: always;"></div>
            `;
        });
        
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Randomized Room Allotment</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                    .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 20px; }
                    .exam-info { margin-bottom: 15px; }
                    .exam-info span { display: inline-block; margin-right: 30px; }
                    .session-title { font-weight: bold; font-size: 14px; margin: 20px 0 10px 0; text-align: center; }
                    .section-title { font-weight: bold; margin: 15px 0 5px 0; }
                    table { border-collapse: collapse; width: 100%; margin-bottom: 15px; }
                    th, td { border: 1px solid #000; padding: 5px; text-align: left; font-size: 12px; }
                    th { background-color: #f0f0f0; font-weight: bold; }
                </style>
            </head>
            <body>
                ${documentContent}
            </body>
            </html>
        `;
        
        // Create PDF using browser's print functionality
        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        
        // Wait for content to load then trigger print dialog
        printWindow.onload = function() {
            printWindow.print();
            // Close the window after printing
            setTimeout(() => {
                printWindow.close();
            }, 1000);
        };
    }
    
    // Export selected departments
    $('#exportDeptBtn').on('click', function() {
        const selectedDepartments = [];
        $('#deptCheckboxes input[type="checkbox"]:checked').each(function() {
            selectedDepartments.push($(this).val());
        });
        
        if (selectedDepartments.length === 0) {
            alert('Please select at least one department to export.');
            return;
        }
        
        exportSelectedDepartments(selectedDepartments);
    });
    
    function exportSelectedDepartments(selectedDepartments) {
        selectedDepartments.forEach(deptName => {
            const deptInfo = departmentData[deptName];
            let documentContent = '';
            
            // Generate document for this department
            documentContent += `
                <div class="header">SIDDAGANGA INSTITUTE OF TECHNOLOGY, TUMAKURU - 572103</div>
                <div class="sub-header">ALLOTMENT OF INVIGILATION DUTY FOR SEMESTER EXAMINATIONS</div>
                <div class="department-title">${deptName} - Exam Allotment</div>
                
                <div class="instructions-section">
                    <div class="instructions-title">General Instructions :</div>
                    <ol class="instructions-list">
                        <li>Deputy chief Supdts are requested to report to duty one hour before the schedule time of the commencement of examinations.</li>
                        <li>Room Supdts/Relieving Supdts are requested to report to duty HALF an hour before the scheduled time of the start of the examinations.</li>
                        <li>Request letter for mutual exchange of duty should be sent through Heads of the concerned Depts to the principal.</li>
                        <li>Mutual exchange is permitted in the same cadre and block transfer of invigilation work is not permitted.</li>
                        <li>Deputy Supdts/Relieving Supdts are requested to refer to the circular issued by VTU on the DUTIES and RESPONSIBILITIES and follow the same.</li>
                    </ol>
                    <div class="cooperation-note">Kind cooperation & involvement of every one is solicited for the Smooth conduct of examinations.</div>
                </div>
            `;
            
            // Professors table - Always create this table
            documentContent += `
                <div class="section-title">Deputy chief Suptds</div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Initials</th>
                        <th>Designation</th>
                        ${deptInfo.professors.length > 0 && deptInfo.professors[0].allocatedDates.length > 0 ? 
                            deptInfo.professors[0].allocatedDates.map(() => `<th></th>`).join('') : 
                            '<th>Allocated Dates</th>'
                        }
                    </tr>
                    ${deptInfo.professors.length > 0 ? 
                        deptInfo.professors.map(prof => `
                            <tr>
                                <td>${prof.name}</td>
                                <td>${prof.initials}</td>
                                <td>${prof.designation}</td>
                                ${prof.allocatedDates.length > 0 ? 
                                    prof.allocatedDates.map(date => `<td>${date}</td>`).join('') : 
                                    '<td>No dates allocated</td>'
                                }
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="4" style="text-align: center; font-style: italic; color: #666;">No professors found in this department</td></tr>'
                    }
                </table>
            `;
            
            // Non-professors table (Invigilators) - Always create this table
            documentContent += `
                <div class="section-title">Invigilators</div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Initials</th>
                        <th>Designation</th>
                        ${deptInfo.nonProfessors.length > 0 && deptInfo.nonProfessors[0].allocatedDates.length > 0 ? 
                            deptInfo.nonProfessors[0].allocatedDates.map(() => `<th></th>`).join('') : 
                            '<th>Allocated Dates</th>'
                        }
                    </tr>
                    ${deptInfo.nonProfessors.length > 0 ? 
                        deptInfo.nonProfessors.map(person => `
                            <tr>
                                <td>${person.name}</td>
                                <td>${person.initials}</td>
                                <td>${person.designation}</td>
                                ${person.allocatedDates.length > 0 ? 
                                    person.allocatedDates.map(date => `<td>${date}</td>`).join('') : 
                                    '<td>No dates allocated</td>'
                                }
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="' + (deptInfo.nonProfessors.length > 0 && deptInfo.nonProfessors[0].allocatedDates.length > 0 ? deptInfo.nonProfessors[0].allocatedDates.length + 3 : 4) + '" style="text-align: center; font-style: italic; color: #666;">No invigilators found in this department</td></tr>'
                    }
                </table>
                
                <div class="footer-section">
                    <div class="timing-info">
                        <div>AM: 09:30 AM TO 12:30PM</div>
                        <div>PM: 02:00 PM TO 05:00PM</div>
                    </div>
                    <div class="signature-text">Principal</div>
                </div>
            `;
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${deptName} - Exam Allotment</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
                        .sub-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 20px; text-decoration: underline; }
                        .department-title { text-align: center; font-weight: bold; font-size: 14px; margin: 20px 0; color: #06457F; }
                        .instructions-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; }
                        .instructions-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; text-decoration: underline; }
                        .instructions-list { margin: 10px 0; padding-left: 20px; }
                        .instructions-list li { margin-bottom: 5px; font-size: 12px; }
                        .cooperation-note { font-weight: bold; text-align: center; margin-top: 15px; font-style: italic; }
                        .section-title { font-weight: bold; margin: 20px 0 10px 0; font-size: 14px; color: #06457F; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f0f0f0; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer-section { margin-top: 80px; position: relative; overflow: hidden; }
                        .timing-info { font-size: 12px; font-weight: bold; float: left; }
                        .timing-info div { margin-bottom: 5px; }
                        .signature-text { font-weight: bold; font-size: 14px; float: right; text-align: right; }
                        .footer-section::after { content: ""; display: table; clear: both; }
                    </style>
                </head>
                <body>
                    ${documentContent}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `${deptName}_Exam_Allotment_${timestamp}.doc`;
            a.download = filename;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            // Small delay between downloads to avoid browser blocking
            setTimeout(() => {}, 100);
        });
    }
    
    // Export selected departments as PDF
    $('#exportDeptPdfBtn').on('click', function() {
        const selectedDepartments = [];
        $('#deptCheckboxes input[type="checkbox"]:checked').each(function() {
            selectedDepartments.push($(this).val());
        });
        
        if (selectedDepartments.length === 0) {
            alert('Please select at least one department to export.');
            return;
        }
        
        exportSelectedDepartmentsPDF(selectedDepartments);
    });
    
    function exportSelectedDepartmentsPDF(selectedDepartments) {
        selectedDepartments.forEach(deptName => {
            const deptInfo = departmentData[deptName];
            let documentContent = '';
            
            // Generate document for this department (same content as DOC)
            documentContent += `
                <div class="header">SIDDAGANGA INSTITUTE OF TECHNOLOGY, TUMAKURU - 572103</div>
                <div class="sub-header">ALLOTMENT OF INVIGILATION DUTY FOR SEMESTER EXAMINATIONS</div>
                <div class="department-title">${deptName} - Exam Allotment</div>
                
                <div class="instructions-section">
                    <div class="instructions-title">General Instructions :</div>
                    <ol class="instructions-list">
                        <li>Deputy chief Supdts are requested to report to duty one hour before the schedule time of the commencement of examinations.</li>
                        <li>Room Supdts/Relieving Supdts are requested to report to duty HALF an hour before the scheduled time of the start of the examinations.</li>
                        <li>Request letter for mutual exchange of duty should be sent through Heads of the concerned Depts to the principal.</li>
                        <li>Mutual exchange is permitted in the same cadre and block transfer of invigilation work is not permitted.</li>
                        <li>Deputy Supdts/Relieving Supdts are requested to refer to the circular issued by VTU on the DUTIES and RESPONSIBILITIES and follow the same.</li>
                    </ol>
                    <div class="cooperation-note">Kind cooperation & involvement of every one is solicited for the Smooth conduct of examinations.</div>
                </div>
            `;
            
            // Deputy chief Suptds table
            documentContent += `
                <div class="section-title">Deputy chief Suptds</div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Initials</th>
                        <th>Designation</th>
                        ${deptInfo.professors.length > 0 && deptInfo.professors[0].allocatedDates.length > 0 ? 
                            deptInfo.professors[0].allocatedDates.map(() => `<th></th>`).join('') : 
                            '<th>Allocated Dates</th>'
                        }
                    </tr>
                    ${deptInfo.professors.length > 0 ? 
                        deptInfo.professors.map(prof => `
                            <tr>
                                <td>${prof.name}</td>
                                <td>${prof.initials}</td>
                                <td>${prof.designation}</td>
                                ${prof.allocatedDates.length > 0 ? 
                                    prof.allocatedDates.map(date => `<td>${date}</td>`).join('') : 
                                    '<td>No dates allocated</td>'
                                }
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="4" style="text-align: center; font-style: italic; color: #666;">No deputy chief superintendents found in this department</td></tr>'
                    }
                </table>
            `;
            
            // Invigilators table
            documentContent += `
                <div class="section-title">Invigilators</div>
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Initials</th>
                        <th>Designation</th>
                        ${deptInfo.nonProfessors.length > 0 && deptInfo.nonProfessors[0].allocatedDates.length > 0 ? 
                            deptInfo.nonProfessors[0].allocatedDates.map(() => `<th></th>`).join('') : 
                            '<th>Allocated Dates</th>'
                        }
                    </tr>
                    ${deptInfo.nonProfessors.length > 0 ? 
                        deptInfo.nonProfessors.map(person => `
                            <tr>
                                <td>${person.name}</td>
                                <td>${person.initials}</td>
                                <td>${person.designation}</td>
                                ${person.allocatedDates.length > 0 ? 
                                    person.allocatedDates.map(date => `<td>${date}</td>`).join('') : 
                                    '<td>No dates allocated</td>'
                                }
                            </tr>
                        `).join('') : 
                        '<tr><td colspan="4" style="text-align: center; font-style: italic; color: #666;">No invigilators found in this department</td></tr>'
                    }
                </table>
                
                <div class="footer-section">
                    <div class="timing-info">
                        <div>AM: 09:30 AM TO 12:30PM</div>
                        <div>PM: 02:00 PM TO 05:00PM</div>
                    </div>
                    <div class="signature-text">Principal</div>
                </div>
            `;
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${deptName} - Exam Allotment</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
                        .sub-header { text-align: center; font-weight: bold; font-size: 14px; margin-bottom: 20px; text-decoration: underline; }
                        .department-title { text-align: center; font-weight: bold; font-size: 14px; margin: 20px 0; color: #06457F; }
                        .instructions-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; }
                        .instructions-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; text-decoration: underline; }
                        .instructions-list { margin: 10px 0; padding-left: 20px; }
                        .instructions-list li { margin-bottom: 5px; font-size: 12px; }
                        .cooperation-note { font-weight: bold; text-align: center; margin-top: 15px; font-style: italic; }
                        .section-title { font-weight: bold; margin: 20px 0 10px 0; font-size: 14px; color: #06457F; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f0f0f0; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .footer-section { margin-top: 80px; position: relative; overflow: hidden; }
                        .timing-info { font-size: 12px; font-weight: bold; float: left; }
                        .timing-info div { margin-bottom: 5px; }
                        .signature-text { font-weight: bold; font-size: 14px; float: right; text-align: right; }
                        .footer-section::after { content: ""; display: table; clear: both; }
                    </style>
                </head>
                <body>
                    ${documentContent}
                </body>
                </html>
            `;
            
            // Create PDF using browser's print functionality
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait for content to load then trigger print dialog
            printWindow.onload = function() {
                printWindow.print();
                // Close the window after printing
                setTimeout(() => {
                    printWindow.close();
                }, 1000);
            };
            
            // Small delay between windows to avoid browser blocking
            setTimeout(() => {}, 500);
        });
    }
});
</script>
{% endblock %}
